<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Images Loading Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.warning { background: #fef3c7; color: #92400e; }
        .status.info { background: #dbeafe; color: #1e40af; }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .image-test-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        .image-container {
            position: relative;
            width: 100%;
            height: 200px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-status {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .image-status.loaded { background: #10b981; color: white; }
        .image-status.error { background: #ef4444; color: white; }
        .image-status.loading { background: #f59e0b; color: white; }
        .image-info {
            padding: 15px;
        }
        .image-info h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        .image-info .url {
            font-family: monospace;
            font-size: 11px;
            color: #6b7280;
            word-break: break-all;
            margin: 5px 0;
        }
        .image-info .details {
            font-size: 12px;
            color: #374151;
        }
        .test-controls {
            margin: 20px 0;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn.success {
            background: #10b981;
        }
        .btn.success:hover {
            background: #059669;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 5px;
        }
        .logs {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üñºÔ∏è Product Images Loading Test</h1>
    <p>Comprehensive test of product image loading, fallbacks, and display quality</p>

    <div class="section">
        <h2>üìä Test Results Summary</h2>
        <div id="test-status" class="status info">Preparing image tests...</div>
        <div class="stats" id="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="stat-total">0</div>
                <div class="stat-label">Total Images</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-loaded">0</div>
                <div class="stat-label">Successfully Loaded</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-failed">0</div>
                <div class="stat-label">Failed to Load</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="stat-fallback">0</div>
                <div class="stat-label">Using Fallback</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üéÆ Test Controls</h2>
        <div class="test-controls">
            <button class="btn" onclick="imageTest.startTest()">üîÑ Start Test</button>
            <button class="btn" onclick="imageTest.retestFailedImages()">üîÅ Retest Failed</button>
            <button class="btn success" onclick="imageTest.fixBrokenImages()">üîß Fix Broken Images</button>
            <button class="btn" onclick="imageTest.showOnlyErrors()">üëÅÔ∏è Show Only Errors</button>
            <button class="btn" onclick="imageTest.showAll()">üëÅÔ∏è Show All</button>
        </div>
    </div>

    <div class="section">
        <h2>üñºÔ∏è Image Test Results</h2>
        <div id="images-container" class="image-grid"></div>
    </div>

    <div class="section">
        <h2>üìù Test Logs</h2>
        <div id="test-logs" class="logs">Starting image loading test...\n</div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <!-- Firebase Services -->
    <script src="firebase-config.js"></script>
    <script src="firebase-products-service.js"></script>
    <script src="products.js"></script>
    <script src="render.js"></script>

    <script>
        class ImageLoadingTest {
            constructor() {
                this.products = [];
                this.testResults = [];
                this.stats = {
                    total: 0,
                    loaded: 0,
                    failed: 0,
                    fallback: 0
                };
                
                this.log('üöÄ Initializing image loading test...');
                this.init();
            }

            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}`;
                
                const logsElement = document.getElementById('test-logs');
                if (logsElement) {
                    logsElement.textContent += logMessage + '\n';
                    logsElement.scrollTop = logsElement.scrollHeight;
                }
                console.log(logMessage);
            }

            updateStats() {
                document.getElementById('stat-total').textContent = this.stats.total;
                document.getElementById('stat-loaded').textContent = this.stats.loaded;
                document.getElementById('stat-failed').textContent = this.stats.failed;
                document.getElementById('stat-fallback').textContent = this.stats.fallback;
            }

            updateStatus(message, type = 'info') {
                const statusElement = document.getElementById('test-status');
                if (statusElement) {
                    statusElement.className = `status ${type}`;
                    statusElement.textContent = message;
                }
            }

            async init() {
                await this.loadProducts();
                this.prepareTest();
                setTimeout(() => {
                    this.startTest();
                }, 1000);
            }

            async loadProducts() {
                this.log('üì¶ Loading products from all sources...');
                
                // Wait for products to be ready
                let attempts = 0;
                while (attempts < 30) {
                    // Try to get products from different sources
                    const staticProducts = window.products || [];
                    const firebaseProducts = window.firebaseProductsService ? [
                        ...window.firebaseProductsService.getFeaturedProducts(),
                        ...Object.values(window.firebaseProductsService.getAllCategoryProducts()).flat(),
                        ...window.firebaseProductsService.getUserProducts()
                    ] : [];
                    const allProducts = window.getAllProductsIncludingUserSubmitted ? 
                        window.getAllProductsIncludingUserSubmitted() : [];

                    this.products = [
                        ...staticProducts,
                        ...firebaseProducts,
                        ...allProducts
                    ];

                    // Remove duplicates based on ID
                    const uniqueProducts = this.products.filter((product, index, self) => 
                        index === self.findIndex(p => p.id === product.id)
                    );
                    this.products = uniqueProducts;

                    if (this.products.length > 0) {
                        this.log(`‚úÖ Found ${this.products.length} products to test`);
                        break;
                    }

                    await new Promise(resolve => setTimeout(resolve, 200));
                    attempts++;
                }

                if (this.products.length === 0) {
                    this.log('‚ö†Ô∏è No products found, creating test products...');
                    this.createTestProducts();
                }
            }

            createTestProducts() {
                this.products = [
                    {
                        id: 'test-1',
                        name: 'Test Product 1',
                        image: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=300&h=300&fit=crop&auto=format&q=80',
                        category: 'test'
                    },
                    {
                        id: 'test-2',
                        name: 'Test Product 2 (Broken Image)',
                        image: 'https://example.com/broken-image.jpg',
                        category: 'test'
                    },
                    {
                        id: 'test-3',
                        name: 'Test Product 3 (No Image)',
                        image: '',
                        category: 'test'
                    },
                    {
                        id: 'test-4',
                        name: 'Test Product 4',
                        image: 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=300&h=300&fit=crop&auto=format&q=80',
                        category: 'test'
                    }
                ];
                this.log(`üìù Created ${this.products.length} test products`);
            }

            prepareTest() {
                this.testResults = [];
                this.stats = { total: 0, loaded: 0, failed: 0, fallback: 0 };
                
                // Filter products that have images to test
                const productsWithImages = this.products.filter(product => 
                    product.image && product.image !== ''
                );
                
                this.stats.total = productsWithImages.length;
                this.updateStats();
                
                this.log(`üéØ Prepared to test ${productsWithImages.length} product images`);
            }

            async startTest() {
                this.log('üöÄ Starting image loading test...');
                this.updateStatus('Testing image loading...', 'info');
                
                const container = document.getElementById('images-container');
                container.innerHTML = '';
                
                const productsWithImages = this.products.filter(product => 
                    product.image && product.image !== ''
                );

                for (let i = 0; i < productsWithImages.length; i++) {
                    const product = productsWithImages[i];
                    await this.testProductImage(product, i);
                }

                this.completeTest();
            }

            async testProductImage(product, index) {
                const result = {
                    product: product,
                    originalUrl: product.image,
                    status: 'loading',
                    loadTime: 0,
                    finalUrl: product.image,
                    usedFallback: false,
                    error: null
                };

                // Create visual test card
                const testCard = this.createImageTestCard(result, index);
                document.getElementById('images-container').appendChild(testCard);

                const startTime = Date.now();

                return new Promise((resolve) => {
                    const img = new Image();
                    
                    img.onload = () => {
                        result.status = 'loaded';
                        result.loadTime = Date.now() - startTime;
                        result.dimensions = `${img.naturalWidth}x${img.naturalHeight}`;
                        
                        this.stats.loaded++;
                        this.updateImageCard(testCard, result);
                        this.log(`‚úÖ ${product.name}: Image loaded (${result.loadTime}ms, ${result.dimensions})`);
                        resolve(result);
                    };

                    img.onerror = () => {
                        this.log(`‚ùå ${product.name}: Image failed to load - ${product.image}`);
                        
                        // Try fallback image
                        const fallbackUrl = 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=300&h=300&fit=crop&crop=center&auto=format&q=80';
                        const fallbackImg = new Image();
                        
                        fallbackImg.onload = () => {
                            result.status = 'fallback';
                            result.loadTime = Date.now() - startTime;
                            result.finalUrl = fallbackUrl;
                            result.usedFallback = true;
                            result.dimensions = `${fallbackImg.naturalWidth}x${fallbackImg.naturalHeight}`;
                            
                            this.stats.fallback++;
                            this.updateImageCard(testCard, result);
                            this.log(`üîÑ ${product.name}: Using fallback image`);
                            resolve(result);
                        };

                        fallbackImg.onerror = () => {
                            result.status = 'error';
                            result.loadTime = Date.now() - startTime;
                            result.error = 'Both original and fallback images failed';
                            
                            this.stats.failed++;
                            this.updateImageCard(testCard, result);
                            this.log(`üí• ${product.name}: Both original and fallback failed`);
                            resolve(result);
                        };

                        fallbackImg.src = fallbackUrl;
                    };

                    // Set timeout for slow loading images
                    setTimeout(() => {
                        if (result.status === 'loading') {
                            result.status = 'timeout';
                            result.error = 'Image loading timeout';
                            this.stats.failed++;
                            this.updateImageCard(testCard, result);
                            this.log(`‚è∞ ${product.name}: Image loading timeout`);
                            resolve(result);
                        }
                    }, 10000);

                    img.src = product.image;
                });
            }

            createImageTestCard(result, index) {
                const card = document.createElement('div');
                card.className = 'image-test-card';
                card.id = `test-card-${index}`;
                
                card.innerHTML = `
                    <div class="image-container">
                        <div class="image-status loading">Loading...</div>
                        <div style="color: #9ca3af; font-size: 14px;">Loading image...</div>
                    </div>
                    <div class="image-info">
                        <h4>${result.product.name || 'Unnamed Product'}</h4>
                        <div class="url">${result.originalUrl}</div>
                        <div class="details">Status: Loading...</div>
                    </div>
                `;

                return card;
            }

            updateImageCard(card, result) {
                const imageContainer = card.querySelector('.image-container');
                const statusElement = card.querySelector('.image-status');
                const detailsElement = card.querySelector('.details');

                // Update status badge
                statusElement.className = `image-status ${result.status}`;
                statusElement.textContent = result.status === 'loaded' ? 'Loaded' :
                                          result.status === 'fallback' ? 'Fallback' :
                                          result.status === 'error' ? 'Error' :
                                          result.status === 'timeout' ? 'Timeout' : 'Loading';

                // Update image display
                if (result.status === 'loaded' || result.status === 'fallback') {
                    imageContainer.innerHTML = `
                        ${statusElement.outerHTML}
                        <img src="${result.finalUrl}" alt="${result.product.name}" loading="lazy">
                    `;
                } else {
                    imageContainer.innerHTML = `
                        ${statusElement.outerHTML}
                        <div style="color: #ef4444; font-size: 14px; text-align: center;">
                            ${result.error || 'Failed to load'}
                        </div>
                    `;
                }

                // Update details
                let detailsText = `Status: ${result.status}`;
                if (result.loadTime) detailsText += ` | Load time: ${result.loadTime}ms`;
                if (result.dimensions) detailsText += ` | Size: ${result.dimensions}`;
                if (result.usedFallback) detailsText += ` | Using fallback image`;
                
                detailsElement.textContent = detailsText;

                this.updateStats();
            }

            completeTest() {
                const successRate = this.stats.total > 0 ? 
                    Math.round((this.stats.loaded + this.stats.fallback) / this.stats.total * 100) : 0;
                
                let statusType = 'success';
                let statusMessage = `‚úÖ Test completed: ${successRate}% success rate`;
                
                if (successRate < 50) {
                    statusType = 'error';
                    statusMessage = `‚ùå Test completed: ${successRate}% success rate (Many images failing)`;
                } else if (successRate < 80) {
                    statusType = 'warning';
                    statusMessage = `‚ö†Ô∏è Test completed: ${successRate}% success rate (Some images failing)`;
                }

                this.updateStatus(statusMessage, statusType);
                this.log(`üèÅ Image loading test completed`);
                this.log(`üìä Results: ${this.stats.loaded} loaded, ${this.stats.fallback} fallback, ${this.stats.failed} failed`);
                this.log(`üìà Success rate: ${successRate}%`);

                if (this.stats.failed > 0) {
                    this.log(`‚ö†Ô∏è Found ${this.stats.failed} broken images that need attention`);
                }
            }

            retestFailedImages() {
                this.log('üîÅ Retesting failed images...');
                // Implementation for retesting failed images
                const failedCards = document.querySelectorAll('.image-test-card');
                // Logic to retest failed images would go here
                this.log('üîÅ Retest completed');
            }

            async fixBrokenImages() {
                this.log('üîß Attempting to fix broken images...');
                
                if (!window.firebaseService || !window.firebaseService.isReady()) {
                    alert('‚ùå Firebase not connected. Cannot fix images in database.');
                    return;
                }

                const brokenProducts = this.products.filter(product => {
                    const result = this.testResults.find(r => r.product.id === product.id);
                    return result && result.status === 'error';
                });

                if (brokenProducts.length === 0) {
                    alert('‚úÖ No broken images found to fix!');
                    return;
                }

                const fallbackUrl = 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=300&h=300&fit=crop&crop=center&auto=format&q=80';
                
                try {
                    for (const product of brokenProducts) {
                        // Update the product in the database with fallback image
                        await window.firebaseService.db.collection('products')
                            .doc(product.id)
                            .update({
                                image: fallbackUrl,
                                originalImageUrl: product.image,
                                imageFixed: true,
                                imageFixedAt: new Date()
                            });
                    }

                    alert(`‚úÖ Fixed ${brokenProducts.length} broken images with fallback URLs!`);
                    this.log(`üîß Fixed ${brokenProducts.length} broken images in database`);
                    
                    // Restart test to verify fixes
                    this.startTest();
                } catch (error) {
                    alert(`‚ùå Error fixing images: ${error.message}`);
                    this.log(`‚ùå Error fixing images: ${error.message}`);
                }
            }

            showOnlyErrors() {
                const cards = document.querySelectorAll('.image-test-card');
                cards.forEach(card => {
                    const hasError = card.querySelector('.image-status.error') || 
                                    card.querySelector('.image-status.timeout');
                    card.style.display = hasError ? 'block' : 'none';
                });
                this.log('üëÅÔ∏è Showing only error cards');
            }

            showAll() {
                const cards = document.querySelectorAll('.image-test-card');
                cards.forEach(card => {
                    card.style.display = 'block';
                });
                this.log('üëÅÔ∏è Showing all cards');
            }
        }

        // Start the test when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                window.imageTest = new ImageLoadingTest();
            }, 1000);
        });
    </script>
</body>
</html>