<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test User Products Fix - SmartDeals Pro</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f7fa;
            border-radius: 10px;
        }
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-card h3 {
            margin-top: 0;
            color: #333;
            font-size: 1.2rem;
        }
        .status-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .success { color: #10b981; }
        .warning { color: #f59e0b; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .product-card {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        .product-card:hover {
            transform: translateY(-2px);
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f3f4f6;
        }
        .product-info {
            padding: 15px;
        }
        .product-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        .product-price {
            color: #10b981;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .product-meta {
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
        }
        .user-submitted {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
        }
        .admin-submitted {
            background: #ecfdf5;
            border-left: 4px solid #10b981;
        }
        .log-container {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üîß User Products Fix Test</h1>
            <p>This page tests whether user-submitted products are now showing up correctly on the site after the fix.</p>
        </div>

        <div class="status-panel">
            <div class="status-card">
                <h3>üî• Firebase Status</h3>
                <div id="firebase-status" class="status-value info">Connecting...</div>
                <div id="firebase-details">Initializing Firebase connection</div>
            </div>
            
            <div class="status-card">
                <h3>üì¶ Total Products</h3>
                <div id="total-products" class="status-value info">0</div>
                <div id="total-details">Loading products...</div>
            </div>
            
            <div class="status-card">
                <h3>üë§ User Submitted</h3>
                <div id="user-products" class="status-value warning">0</div>
                <div id="user-details">Counting user products...</div>
            </div>
            
            <div class="status-card">
                <h3>‚≠ê Admin Products</h3>
                <div id="admin-products" class="status-value success">0</div>
                <div id="admin-details">Counting admin products...</div>
            </div>
        </div>

        <div id="products-container" class="products-grid">
            <!-- Products will be loaded here -->
        </div>

        <div class="log-container" id="log-container">
            <div><strong>üîç Debug Log:</strong></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <script>
        let allProducts = [];
        let userSubmittedProducts = [];
        let adminProducts = [];

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logContainer.innerHTML += `<div>[${timestamp}] ${icon} ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(elementId, value, className = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                element.className = `status-value ${className}`;
            }
        }

        function updateDetails(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            }
        }

        async function initializeFirebase() {
            try {
                addLog('Initializing Firebase...');
                
                const firebaseConfig = {
                    apiKey: "AIzaSyBJqBEWDdBlfv5xAjgcvqput1KC1NzKvlU",
                    authDomain: "smart-deals-pro.firebaseapp.com",
                    projectId: "smart-deals-pro",
                    storageBucket: "smart-deals-pro.firebasestorage.app",
                    messagingSenderId: "680016915696",
                    appId: "1:680016915696:web:4b3721313ea0e2e3342635",
                    measurementId: "G-HV5N0LQJTG"
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                const db = firebase.firestore();
                updateStatus('firebase-status', 'Connected', 'success');
                updateDetails('firebase-details', 'Firebase connected successfully');
                addLog('Firebase initialized successfully', 'success');
                
                return db;
            } catch (error) {
                addLog(`Firebase initialization failed: ${error.message}`, 'error');
                updateStatus('firebase-status', 'Failed', 'error');
                updateDetails('firebase-details', `Error: ${error.message}`);
                throw error;
            }
        }

        async function loadProducts() {
            try {
                addLog('Loading products from Firebase...');
                const db = await initializeFirebase();
                
                const snapshot = await db.collection('products')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                
                allProducts = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Separate user-submitted from admin products
                userSubmittedProducts = allProducts.filter(product => product.submittedBy);
                adminProducts = allProducts.filter(product => !product.submittedBy);
                
                addLog(`Loaded ${allProducts.length} total products`, 'success');
                addLog(`Found ${userSubmittedProducts.length} user-submitted products`, userSubmittedProducts.length > 0 ? 'success' : 'warning');
                addLog(`Found ${adminProducts.length} admin products`, 'info');
                
                updateStatus('total-products', allProducts.length, allProducts.length > 0 ? 'success' : 'warning');
                updateDetails('total-details', `${allProducts.length} products loaded from Firebase`);
                
                updateStatus('user-products', userSubmittedProducts.length, userSubmittedProducts.length > 0 ? 'success' : 'warning');
                updateDetails('user-details', `${userSubmittedProducts.length} products submitted by users`);
                
                updateStatus('admin-products', adminProducts.length, adminProducts.length > 0 ? 'success' : 'info');
                updateDetails('admin-details', `${adminProducts.length} products added by admin`);
                
                displayProducts();
                
            } catch (error) {
                addLog(`Failed to load products: ${error.message}`, 'error');
                updateStatus('total-products', 'Error', 'error');
                updateDetails('total-details', `Failed to load: ${error.message}`);
            }
        }

        function displayProducts() {
            const container = document.getElementById('products-container');
            
            if (allProducts.length === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; background: #fff; border-radius: 8px;"><h3>No products found</h3><p>No products were loaded from Firebase.</p></div>';
                return;
            }

            const productsHTML = allProducts.map(product => {
                const isUserSubmitted = product.submittedBy;
                const cardClass = isUserSubmitted ? 'user-submitted' : 'admin-submitted';
                const submissionType = isUserSubmitted ? 'üë§ User Submitted' : '‚≠ê Admin Product';
                const submittedBy = isUserSubmitted ? `by ${product.submittedBy}` : 'by Admin';
                
                return `
                    <div class="product-card ${cardClass}">
                        <img src="${product.image && !product.image.includes('placeholder') ? product.image : 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=280&h=200&fit=crop&crop=center&auto=format&q=80'}" 
                             alt="${product.title || product.name}" 
                             class="product-image" 
                             onerror="this.src='https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=280&h=200&fit=crop&crop=center&auto=format&q=80'; this.onerror=null;">
                        <div class="product-info">
                            <div class="product-title">${product.title || product.name || 'Untitled Product'}</div>
                            <div class="product-price">${product.price || 'Price not set'}</div>
                            <div class="product-meta">
                                <div><strong>${submissionType}</strong> ${submittedBy}</div>
                                <div>Category: ${product.category || 'Uncategorized'}</div>
                                <div>ID: ${product.id}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = productsHTML;
            addLog(`Displayed ${allProducts.length} products in grid`, 'success');
        }

        // Initialize the test when page loads
        document.addEventListener('DOMContentLoaded', () => {
            addLog('Test page loaded, starting product load test...');
            loadProducts();
        });
    </script>
</body>
</html>