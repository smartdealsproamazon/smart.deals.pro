<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registration Storage Test - SmartDeals Pro</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f8fafc;
      color: #1f2937;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .test-section {
      background: white;
      padding: 25px;
      margin: 20px 0;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .test-section h3 {
      margin-top: 0;
      color: #3b82f6;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 10px;
    }
    
    .status {
      padding: 10px 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: 600;
    }
    
    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }
    
    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
    }
    
    .status.warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #f59e0b;
    }
    
    .data-display {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #d1d5db;
    }
    
    .button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin: 10px 10px 10px 0;
      transition: background-color 0.3s;
    }
    
    .button:hover {
      background: #2563eb;
    }
    
    .button.danger {
      background: #ef4444;
    }
    
    .button.danger:hover {
      background: #dc2626;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Registration Data Storage Test</h1>
    <p>This page will help you check where your registration data is being saved and troubleshoot any issues.</p>
    
    <!-- Firebase Status -->
    <div class="test-section">
      <h3>üî• Firebase Connection Status</h3>
      <div id="firebaseStatus">Checking Firebase connection...</div>
      <div id="firebaseDetails"></div>
    </div>
    
    <!-- localStorage Data -->
    <div class="test-section">
      <h3>üì± localStorage Data</h3>
      <div id="localStorageStatus">Checking localStorage...</div>
      <div id="localStorageData" class="data-display"></div>
      <button class="button danger" onclick="clearLocalStorage()">Clear localStorage</button>
    </div>
    
    <!-- Firebase Data -->
    <div class="test-section">
      <h3>‚òÅÔ∏è Firebase Data</h3>
      <div id="firebaseDataStatus">Checking Firebase data...</div>
      <div id="firebaseData" class="data-display"></div>
      <button class="button" onclick="testFirebaseConnection()">Test Firebase Connection</button>
      <button class="button" onclick="syncLocalToFirebase()">Sync localStorage to Firebase</button>
    </div>
    
    <!-- Registration Test -->
    <div class="test-section">
      <h3>üß™ Registration Test</h3>
      <p>Test the registration process with sample data:</p>
      <button class="button" onclick="testRegistration()">Test Registration Process</button>
      <div id="registrationTestResult"></div>
    </div>
  </div>

  <script>
    // Firebase status check
    async function checkFirebaseStatus() {
      const statusDiv = document.getElementById('firebaseStatus');
      const detailsDiv = document.getElementById('firebaseDetails');
      
      try {
        if (typeof firebase === 'undefined') {
          statusDiv.innerHTML = '<div class="status error">‚ùå Firebase SDK not loaded</div>';
          detailsDiv.innerHTML = '<p>Firebase scripts may not be loaded properly. Check your internet connection.</p>';
          return false;
        }
        
        if (!firebase.firestore) {
          statusDiv.innerHTML = '<div class="status error">‚ùå Firestore not available</div>';
          detailsDiv.innerHTML = '<p>Firestore service is not available. Check Firebase configuration.</p>';
          return false;
        }
        
        if (!window.firebaseUserService) {
          statusDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è Firebase service not initialized</div>';
          detailsDiv.innerHTML = '<p>FirebaseUserService is not available. Service may still be loading...</p>';
          return false;
        }
        
        // Test Firebase connection
        const testDoc = firebase.firestore().collection('test').doc('connection');
        await testDoc.set({ timestamp: new Date(), test: true });
        await testDoc.delete();
        
        statusDiv.innerHTML = '<div class="status success">‚úÖ Firebase connected and working</div>';
        detailsDiv.innerHTML = `
          <p><strong>Project ID:</strong> smart-deals-pro</p>
          <p><strong>Service:</strong> Available</p>
          <p><strong>Connection:</strong> Active</p>
        `;
        return true;
        
      } catch (error) {
        statusDiv.innerHTML = '<div class="status error">‚ùå Firebase connection failed</div>';
        detailsDiv.innerHTML = `<p><strong>Error:</strong> ${error.message}</p>`;
        return false;
      }
    }
    
    // Check localStorage data
    function checkLocalStorageData() {
      const statusDiv = document.getElementById('localStorageStatus');
      const dataDiv = document.getElementById('localStorageData');
      
      const currentUser = localStorage.getItem('smartdeals_currentUser');
      const affiliateData = localStorage.getItem('smartdeals_affiliateRegistered');
      const users = localStorage.getItem('smartdeals_users');
      
      let dataFound = false;
      let dataDisplay = '';
      
      if (currentUser) {
        dataFound = true;
        const user = JSON.parse(currentUser);
        dataDisplay += `CURRENT USER:\n${JSON.stringify(user, null, 2)}\n\n`;
      }
      
      if (affiliateData) {
        dataFound = true;
        const affiliate = JSON.parse(affiliateData);
        dataDisplay += `AFFILIATE DATA:\n${JSON.stringify(affiliate, null, 2)}\n\n`;
      }
      
      if (users) {
        dataFound = true;
        const usersList = JSON.parse(users);
        dataDisplay += `USERS ARRAY (${usersList.length} users):\n${JSON.stringify(usersList, null, 2)}\n\n`;
      }
      
      if (dataFound) {
        statusDiv.innerHTML = '<div class="status success">‚úÖ Registration data found in localStorage</div>';
        dataDiv.textContent = dataDisplay;
      } else {
        statusDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è No registration data found in localStorage</div>';
        dataDiv.textContent = 'No registration data found. Try registering first.';
      }
    }
    
    // Check Firebase data
    async function checkFirebaseData() {
      const statusDiv = document.getElementById('firebaseDataStatus');
      const dataDiv = document.getElementById('firebaseData');
      
      try {
        if (!window.firebaseUserService) {
          statusDiv.innerHTML = '<div class="status error">‚ùå Firebase service not available</div>';
          dataDiv.textContent = 'Cannot check Firebase data - service not available';
          return;
        }
        
        // Get current user's data from localStorage to search Firebase
        const currentUser = localStorage.getItem('smartdeals_currentUser');
        if (!currentUser) {
          statusDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è No user logged in to check Firebase data</div>';
          dataDiv.textContent = 'Please register or sign in first to check Firebase data';
          return;
        }
        
        const user = JSON.parse(currentUser);
        
        // Check if user exists in Firebase
        const userResult = await window.firebaseUserService.getUserByEmail(user.email);
        const affiliateResult = await window.firebaseUserService.getAffiliateByEmail(user.email);
        
        let firebaseDataDisplay = '';
        let hasFirebaseData = false;
        
        if (userResult) {
          hasFirebaseData = true;
          firebaseDataDisplay += `USER DATA IN FIREBASE:\n${JSON.stringify(userResult, null, 2)}\n\n`;
        }
        
        if (affiliateResult && affiliateResult.success) {
          hasFirebaseData = true;
          firebaseDataDisplay += `AFFILIATE DATA IN FIREBASE:\n${JSON.stringify(affiliateResult.affiliate, null, 2)}\n\n`;
        }
        
        if (hasFirebaseData) {
          statusDiv.innerHTML = '<div class="status success">‚úÖ Registration data found in Firebase</div>';
          dataDiv.textContent = firebaseDataDisplay;
        } else {
          statusDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è No registration data found in Firebase</div>';
          dataDiv.textContent = 'No Firebase data found. Data may be stored only in localStorage.';
        }
        
      } catch (error) {
        statusDiv.innerHTML = '<div class="status error">‚ùå Error checking Firebase data</div>';
        dataDiv.textContent = `Error: ${error.message}`;
      }
    }
    
    // Test Firebase connection
    async function testFirebaseConnection() {
      const statusDiv = document.getElementById('firebaseDataStatus');
      statusDiv.innerHTML = '<div class="status">üîÑ Testing Firebase connection...</div>';
      
      await checkFirebaseData();
    }
    
    // Clear localStorage
    function clearLocalStorage() {
      if (confirm('Are you sure you want to clear all registration data from localStorage?')) {
        localStorage.removeItem('smartdeals_currentUser');
        localStorage.removeItem('smartdeals_affiliateRegistered');
        localStorage.removeItem('smartdeals_users');
        
        alert('localStorage cleared!');
        checkLocalStorageData();
      }
    }
    
    // Sync localStorage to Firebase
    async function syncLocalToFirebase() {
      try {
        const currentUser = localStorage.getItem('smartdeals_currentUser');
        const affiliateData = localStorage.getItem('smartdeals_affiliateRegistered');
        
        if (!currentUser || !affiliateData) {
          alert('No localStorage data to sync');
          return;
        }
        
        if (!window.firebaseUserService) {
          alert('Firebase service not available');
          return;
        }
        
        const user = JSON.parse(currentUser);
        const affiliate = JSON.parse(affiliateData);
        
        // Try to register in Firebase
        const result = await window.firebaseUserService.registerAffiliate(affiliate);
        
        if (result.success) {
          alert('‚úÖ Data successfully synced to Firebase!');
          await checkFirebaseData();
        } else {
          alert('‚ùå Sync failed: ' + result.error);
        }
        
      } catch (error) {
        alert('‚ùå Sync error: ' + error.message);
      }
    }
    
    // Test registration process
    async function testRegistration() {
      const resultDiv = document.getElementById('registrationTestResult');
      resultDiv.innerHTML = '<div class="status">üîÑ Testing registration...</div>';
      
      const testData = {
        personalInfo: {
          firstName: 'Test',
          lastName: 'User',
          email: 'test' + Date.now() + '@example.com',
          phone: '+1234567890',
          country: 'US'
        },
        experience: {
          level: 'beginner',
          platforms: ['amazon'],
          revenue: 'under-1000'
        },
        onlinePresence: {
          website: 'https://example.com',
          strategy: 'content-marketing'
        },
        agreements: {
          terms: 'on',
          marketing: 'on',
          quality: 'on'
        },
        registrationDate: new Date().toISOString()
      };
      
      try {
        if (window.firebaseUserService) {
          const result = await window.firebaseUserService.registerAffiliate(testData);
          
          if (result.success) {
            resultDiv.innerHTML = '<div class="status success">‚úÖ Test registration successful in Firebase!</div>';
            
            // Also save to localStorage for testing
            const userData = {
              name: `${testData.personalInfo.firstName} ${testData.personalInfo.lastName}`,
              email: testData.personalInfo.email,
              phone: testData.personalInfo.phone,
              country: testData.personalInfo.country,
              registrationDate: new Date().toISOString(),
              firestoreId: result.id
            };
            
            localStorage.setItem('smartdeals_currentUser', JSON.stringify(userData));
            localStorage.setItem('smartdeals_affiliateRegistered', JSON.stringify({
              ...result.affiliate,
              userData: userData
            }));
            
            // Refresh data displays
            setTimeout(() => {
              checkLocalStorageData();
              checkFirebaseData();
            }, 1000);
            
          } else {
            resultDiv.innerHTML = `<div class="status error">‚ùå Test registration failed: ${result.error}</div>`;
          }
        } else {
          resultDiv.innerHTML = '<div class="status error">‚ùå Firebase service not available</div>';
        }
        
      } catch (error) {
        resultDiv.innerHTML = `<div class="status error">‚ùå Test error: ${error.message}</div>`;
      }
    }
    
    // Initialize checks
    window.addEventListener('load', async function() {
      console.log('Starting storage tests...');
      
      // Wait a bit for Firebase to load
      setTimeout(async () => {
        await checkFirebaseStatus();
        checkLocalStorageData();
        await checkFirebaseData();
      }, 2000);
    });
  </script>
  
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-user-service.js"></script>
</body>
</html>