<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Product Submission - SmartDeals Pro</title>
  <link rel="icon" type="image/svg+xml" href="logo.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="main-header">
    <div class="container">
      <div class="header-content">
        <div class="header-left">
          <a href="index.html" class="logo-link">
            <img src="logo.svg?v=2024.1" alt="SmartDeals Pro Logo" class="logo" loading="eager" />
          </a>
          <div class="site-name">
            <span class="logo-text">User Product Submission</span>
          </div>
        </div>
        <nav class="main-nav">
          <ul>
            <li><a href="index.html" class="nav-link">Home</a></li>
            <li><a href="marketplace.html" class="nav-link">Marketplace</a></li>
            <li><a href="affiliate-dashboard.html" class="nav-link">Dashboard</a></li>
          </ul>
        </nav>
        <div class="header-right">
          <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
            <i class="fas fa-bars"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="mobile-menu" id="mobileMenu">
    <div class="mobile-menu-content">
      <button class="mobile-menu-close" onclick="toggleMobileMenu()" aria-label="Close menu">
        <i class="fas fa-times"></i>
      </button>
      <a href="index.html">Home</a>
      <a href="marketplace.html">Marketplace</a>
      <a href="affiliate-dashboard.html">Dashboard</a>
    </div>
  </div>

  <section class="features-section" style="padding-top: 2rem;">
    <div class="container">
      <div class="section-header" style="text-align:center;">
        <h2 class="section-title">Add a New Product</h2>
        <p class="section-subtitle">Fill the details below. Your product will appear in Marketplace.</p>
      </div>

      <div class="dashboard-section" style="max-width: 760px; margin: 0 auto;">
        <div class="section-content">
          <form id="userProductForm">
            <div class="form-group" style="margin-bottom: 1rem;">
              <label for="title" style="display:block; font-weight:600; margin-bottom:0.25rem;">Product Title</label>
              <input id="title" type="text" placeholder="Enter product title" required style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #e5e7eb;">
            </div>

            <div class="form-group" style="margin-bottom: 1rem;">
              <label for="imageUrl" style="display:block; font-weight:600; margin-bottom:0.25rem;">Image URL (optional)</label>
              <input id="imageUrl" type="url" placeholder="https://example.com/image.jpg" style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #e5e7eb;">
              <small style="color:#6b7280;">Or upload an image file below.</small>
            </div>

            <div class="form-group" style="margin-bottom: 1rem;">
              <label for="imageFile" style="display:block; font-weight:600; margin-bottom:0.25rem;">Upload Image (optional)</label>
              <input id="imageFile" type="file" accept="image/*" style="width:100%; padding:0.5rem; border-radius:8px; border:1px solid #e5e7eb; background:#fff;">
            </div>

            <div class="form-group" style="margin-bottom: 1rem;">
              <label for="price" style="display:block; font-weight:600; margin-bottom:0.25rem;">Price</label>
              <input id="price" type="text" inputmode="decimal" placeholder="$19.99" required style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #e5e7eb;">
            </div>

            <div class="form-group" style="margin-bottom: 1rem;">
              <label for="description" style="display:block; font-weight:600; margin-bottom:0.25rem;">Description</label>
              <textarea id="description" rows="4" placeholder="Enter product description" required style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #e5e7eb;"></textarea>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
              <label for="link" style="display:block; font-weight:600; margin-bottom:0.25rem;">Product Link</label>
              <input id="link" type="url" placeholder="https://your-affiliate-link" required style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #e5e7eb;">
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
              <label for="category" style="display:block; font-weight:600; margin-bottom:0.25rem;">Category</label>
              <select id="category" required style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #e5e7eb; background:#fff;">
                <option value="">Select Category</option>
                <option value="boys">Boys Fashion</option>
                <option value="girls">Girls Fashion</option>
                <option value="electrical">Electronics</option>
                <option value="gaming">Gaming</option>
                <option value="home-garden">Home & Garden</option>
                <option value="smartwatch">Smartwatches</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
              <label for="platform" style="display:block; font-weight:600; margin-bottom:0.25rem;">Platform</label>
              <select id="platform" required style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #e5e7eb; background:#fff;">
                <option value="">Select Platform</option>
                <option value="amazon">Amazon</option>
                <option value="clickbank">ClickBank</option>
                <option value="shareasale">ShareASale</option>
                <option value="cj">Commission Junction</option>
                <option value="rakuten">Rakuten</option>
                <option value="impact">Impact</option>
                <option value="shopify">Shopify Partners</option>
                <option value="etsy">Etsy</option>
                <option value="ebay">eBay Partner</option>
                <option value="other">Other Platform</option>
              </select>
            </div>

            <div class="form-actions" style="display:flex; gap:0.75rem;">
              <button type="submit" class="btn btn-primary" id="submitBtn"><i class="fas fa-save"></i>&nbsp;Submit Product</button>
              <a href="affiliate-dashboard.html" class="btn btn-secondary">Cancel</a>
            </div>

            <div id="formError" style="display:none; margin-top: 1rem; color:#ef4444; font-weight:600;"></div>
            <div id="formSuccess" style="display:none; margin-top: 1rem; color:#16a34a; font-weight:700;"></div>
            
            <!-- Progress Bar -->
            <div id="progressBar" style="display: none; width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; margin-top: 1rem;">
              <div id="progressFill" style="height: 100%; background: #2563eb; width: 0%; transition: width 0.3s ease;"></div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Firebase SDK Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  
  <script src="products.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBJqBEWDdBlfv5xAjgcvqput1KC1NzKvlU",
      authDomain: "smart-deals-pro.firebaseapp.com",
      projectId: "smart-deals-pro",
      storageBucket: "smart-deals-pro.firebasestorage.app",
      messagingSenderId: "680016915696",
      appId: "1:680016915696:web:4b3721313ea0e2e3342635",
      measurementId: "G-HV5N0LQJTG"
    };

    let db;
    let isSubmitting = false;

    // Initialize Firebase with proper error handling
    function initializeFirebase() {
      return new Promise((resolve, reject) => {
        try {
          if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
          }
          db = firebase.firestore();
          console.log("Firebase initialized successfully");
          resolve();
        } catch (error) {
          console.error("Firebase initialization failed:", error);
          reject(error);
        }
      });
    }

    // Timeout wrapper for promises
    function withTimeout(promise, ms) {
      return new Promise((resolve, reject) => {
        const timeoutId = setTimeout(() => {
          reject(new Error(`Operation timed out after ${ms}ms`));
        }, ms);
        
        promise.then(
          (result) => {
            clearTimeout(timeoutId);
            resolve(result);
          },
          (error) => {
            clearTimeout(timeoutId);
            reject(error);
          }
        );
      });
    }

    // Update progress bar
    function updateProgress(percentage) {
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      
      if (percentage > 0) {
        progressBar.style.display = 'block';
        progressFill.style.width = percentage + '%';
      } else {
        progressBar.style.display = 'none';
        progressFill.style.width = '0%';
      }
    }

    // Reset form state
    function resetFormState() {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-save"></i>&nbsp;Submit Product';
      updateProgress(0);
      isSubmitting = false;
    }

    // Process image with timeout and size check
    function processImage(file) {
      return new Promise((resolve, reject) => {
        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          reject(new Error('Image size must be less than 5MB'));
          return;
        }

        const reader = new FileReader();
        const timeout = setTimeout(() => {
          reader.abort();
          reject(new Error('Image processing timed out'));
        }, 30000); // 30 second timeout

        reader.onload = function() {
          clearTimeout(timeout);
          resolve(reader.result);
        };

        reader.onerror = function() {
          clearTimeout(timeout);
          reject(new Error('Failed to read image file'));
        };

        reader.readAsDataURL(file);
      });
    }

    function toggleMobileMenu() {
      const mobileMenu = document.getElementById('mobileMenu');
      mobileMenu.classList.toggle('active');
    }

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    document.addEventListener('DOMContentLoaded', function() {
      const accessEmail = localStorage.getItem('smartdeals_user_submission_access');
      const currentUserRaw = localStorage.getItem('smartdeals_currentUser');
      let currentUserEmail = '';
      try { currentUserEmail = JSON.parse(currentUserRaw)?.email?.toLowerCase() || ''; } catch (e) {}

      const emailParam = (getQueryParam('email') || '').toLowerCase();

      if (!currentUserEmail || !accessEmail || accessEmail.toLowerCase() !== currentUserEmail || emailParam !== currentUserEmail) {
        alert('Access denied. Please verify your email first.');
        window.location.href = 'user-product-access.html';
        return;
      }

      // Initialize Firebase
      initializeFirebase().catch(error => {
        console.error("Firebase initialization failed:", error);
        // Continue with form - will use fallback if needed
      });

      const form = document.getElementById('userProductForm');
      const errorBox = document.getElementById('formError');
      const successBox = document.getElementById('formSuccess');

      // Function to send user product submission notification email
      async function sendUserProductSubmissionEmail(product) {
        try {
          const payload = {
            _subject: 'New User Product Submission - SmartDeals Pro',
            productTitle: product.title || product.name,
            price: product.price,
            category: product.category,
            description: product.description,
            productLink: product.link,
            submittedBy: product.submittedBy,
            userDisplayName: product.userDisplayName || 'Unknown User',
            submissionDate: new Date().toLocaleString(),
            submissionType: 'User Product Submission'
          };

          const response = await fetch('https://formsubmit.co/ajax/smartdealsproamazon@gmail.com', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          return result;
        } catch (error) {
          console.error('Failed to send user product submission email:', error);
          throw error;
        }
      }

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Prevent double submission
        if (isSubmitting) {
          return;
        }

        isSubmitting = true;
        errorBox.style.display = 'none';
        successBox.style.display = 'none';

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>&nbsp;Submitting...';
        
        updateProgress(10);

        try {
          const title = document.getElementById('title').value.trim();
          const imageUrl = document.getElementById('imageUrl').value.trim();
          const imageFile = document.getElementById('imageFile').files[0] || null;
          const price = document.getElementById('price').value.trim();
          const description = document.getElementById('description').value.trim();
          const link = document.getElementById('link').value.trim();
          const category = document.getElementById('category').value.trim();
          const platform = document.getElementById('platform').value.trim();

          if (!title || !price || !description || !link || !category || !platform) {
            errorBox.textContent = 'Please fill in all required fields including category.';
            errorBox.style.display = 'block';
            resetFormState();
            return;
          }

          updateProgress(30);

          let imageData = '';
          try {
            if (imageFile) {
              imageData = await withTimeout(processImage(imageFile), 30000);
            } else if (imageUrl) {
              imageData = imageUrl;
            }
          } catch (e) {
            console.warn('Image processing failed:', e);
            errorBox.textContent = 'Image processing failed: ' + e.message;
            errorBox.style.display = 'block';
            resetFormState();
            return;
          }

          updateProgress(60);

          // Build product object
          const product = {
            title: title,
            name: title,
            image: imageData || imageUrl || '',
            imageData: imageData || undefined,
            price: price,
            originalPrice: price,
            description: description,
            link: link,
            platform: platform,
            category: category, // Use selected category instead of hardcoded 'users-products'
            rating: 5,
            reviews: 0,
            discount: 0,
            featured: false,
            createdAt: firebase && firebase.firestore ? firebase.firestore.FieldValue.serverTimestamp() : new Date().toISOString(),
            ownerEmail: currentUserEmail,
            submittedBy: currentUserEmail // Mark as user-submitted
          };

          updateProgress(80);

          try {
            // Try Firebase submission with timeout
            if (db) {
              // Add user ID to product for user-specific tracking
              const currentUser = JSON.parse(localStorage.getItem('smartdeals_currentUser') || '{}');
              product.userId = currentUser.email || 'anonymous';
              product.userDisplayName = currentUser.name || 'Anonymous User';
              
              const docRef = await withTimeout(
                db.collection('products').add(product),
                15000
              );
              console.log('Product written to Firebase with ID:', docRef.id);

              // Send email notification to admin
              try {
                await sendUserProductSubmissionEmail(product);
                console.log("User product submission notification email sent successfully");
              } catch (emailError) {
                console.error("Failed to send notification email:", emailError);
                // Don't fail the submission if email fails
              }

              updateProgress(100);
              successBox.textContent = 'Product added successfully to Firebase! Redirecting to Marketplace...';
              successBox.style.display = 'block';
              
              setTimeout(() => {
                localStorage.removeItem('smartdeals_user_submission_access');
                window.location.href = 'marketplace.html';
              }, 1500);
            } else {
              throw new Error('Firebase not initialized. Please refresh the page and try again.');
            }
          } catch (firebaseError) {
            console.error('Firebase submission failed:', firebaseError);
            updateProgress(100);
            errorBox.textContent = 'Failed to save product to Firebase. Please check your internet connection and try again.';
            errorBox.style.display = 'block';
            resetFormState();
            throw new Error('Failed to save product to Firebase. Please try again.');
          }

        } catch (error) {
          console.error('Submission error:', error);
          errorBox.textContent = error.message || 'Failed to save product. Please try again.';
          errorBox.style.display = 'block';
          resetFormState();
        }
      });
    });
  </script>
</body>
</html>

