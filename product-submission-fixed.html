<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Submit a Product - SmartDeals Pro</title>
  <meta name="description" content="Submit your product to be featured on SmartDeals Pro." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css" />
  <!-- Inline styles specific to the submission form -->
  <style>
    body {
      background: #f5f7fa;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 2rem 1rem;
      font-family: Arial, Helvetica, sans-serif;
    }
    .card {
      background: #fff;
      width: 100%;
      max-width: 500px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 2rem 1.5rem;
    }
    h1 {
      margin-bottom: 1.5rem;
      text-align: center;
      color: #333;
      font-size: 1.8rem;
    }
    .form-group {
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
    }
    label {
      margin-bottom: 0.4rem;
      color: #555;
      font-weight: 600;
    }
    input[type="text"],
    input[type="url"],
    input[type="number"],
    input[type="email"],
    textarea,
    select {
      padding: 0.55rem 0.75rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    input[type="file"] {
      padding: 0.4rem 0;
    }
    .btn {
      width: 100%;
      padding: 0.75rem;
      margin-top: 1rem;
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .btn:hover:not(:disabled) {
      background: #1d4ed8;
    }
    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .error {
      color: #dc2626;
      margin-top: 0.25rem;
      font-size: 0.9rem;
    }
    .success {
      color: #10b981;
      margin-top: 0.25rem;
      font-size: 0.9rem;
    }
    .warning {
      color: #f59e0b;
      margin-top: 0.25rem;
      font-size: 0.9rem;
    }
    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e5e7eb;
      border-radius: 2px;
      overflow: hidden;
      margin: 1rem 0;
    }
    .progress-fill {
      height: 100%;
      background: #2563eb;
      width: 0%;
      transition: width 0.3s ease;
    }
    .status-message {
      text-align: center;
      margin: 1rem 0;
      padding: 0.75rem;
      border-radius: 4px;
      font-weight: 500;
    }
    .status-message.info {
      background: #e0f2fe;
      color: #0277bd;
    }
    .status-message.success {
      background: #e8f5e8;
      color: #2e7d32;
    }
    .status-message.error {
      background: #ffebee;
      color: #c62828;
    }
    .status-message.warning {
      background: #fff8e1;
      color: #ef6c00;
    }
    @media (max-width: 480px) {
      body {
        padding: 1rem 0.5rem;
      }
      .card {
        padding: 1.5rem 1rem;
        margin: 0;
      }
      h1 {
        font-size: 1.5rem;
      }
      .main-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      body {
        margin-top: 80px;
      }
    }
  </style>
</head>
<body>
  <!-- Header (simplified) -->
  <header class="main-header" style="width:100%;">
    <div class="container">
      <div class="header-content">
        <div class="header-left">
          <a href="index.html" class="logo-link">
            <img src="logo.svg" alt="SmartDeals Pro Logo" class="logo" />
            <span class="logo-text">SmartDeals Pro</span>
          </a>
        </div>
        <nav class="main-nav">
          <ul>
            <li><a href="index.html" class="nav-link">Home</a></li>
            <li class="dropdown">
              <a href="#" class="nav-link dropdown-toggle">Categories <i class="fas fa-chevron-down"></i></a>
              <ul class="dropdown-menu">
                <li><a href="smartwatches.html">Smartwatches</a></li>
                <li><a href="fashion.html">Fashion</a></li>
                <li><a href="small-electrical.html">Electronics</a></li>
                <li><a href="gaming.html">Gaming</a></li>
                <li><a href="home-garden.html">Home & Garden</a></li>
                <li><a href="product-submission.html">Submit Product</a></li>
              </ul>
            </li>
            <li><a href="reviews.html" class="nav-link">Reviews</a></li>
            <li><a href="deals.html" class="nav-link">Hot Deals</a></li>
            <li><a href="about.html" class="nav-link">About</a></li>
            <li><a href="contact.html" class="nav-link">Contact</a></li>
            <li><a href="product-submission.html" class="nav-link active">Submit Product</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <!-- Submission Form -->
  <div class="card">
    <h1>Product Submission</h1>
    
    <form id="productForm" novalidate>
      <div class="form-group">
        <label for="productTitle">Product Title</label>
        <input type="text" id="productTitle" required />
        <span class="error" id="titleError"></span>
      </div>

      <div class="form-group">
        <label for="productImage">Image Upload (Max 5MB)</label>
        <input type="file" id="productImage" accept="image/*" required />
        <span class="error" id="imageError"></span>
      </div>

      <div class="form-group">
        <label for="price">Price (USD)</label>
        <input type="number" step="0.01" id="price" required />
        <span class="error" id="priceError"></span>
      </div>

      <!-- Category Selection -->
      <div class="form-group">
        <label for="category">Category</label>
        <select id="category" required>
          <option value="">Select Category</option>
          <option value="smartwatch">Smartwatches</option>
          <option value="fashion">Fashion</option>
          <option value="electrical">Electronics</option>
          <option value="gaming">Gaming</option>
          <option value="home-garden">Home & Garden</option>
        </select>
        <span class="error" id="categoryError"></span>
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea id="description" required></textarea>
        <span class="error" id="descriptionError"></span>
      </div>

      <div class="form-group">
        <label for="productLink">Product Link</label>
        <input type="url" id="productLink" placeholder="https://example.com" required />
        <span class="error" id="linkError"></span>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" required />
        <span class="error" id="emailError"></span>
      </div>

      <button type="submit" class="btn" id="submitBtn">Submit Product</button>
      
      <!-- Progress Bar -->
      <div class="progress-bar" id="progressBar" style="display: none;">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      
      <!-- Status Message -->
      <div id="statusMessage" class="status-message" style="display: none;"></div>
    </form>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBJqBEWDdBlfv5xAjgcvqput1KC1NzKvlU",
      authDomain: "smart-deals-pro.firebaseapp.com",
      projectId: "smart-deals-pro",
      storageBucket: "smart-deals-pro.firebasestorage.app",
      messagingSenderId: "680016915696",
      appId: "1:680016915696:web:4b3721313ea0e2e3342635",
      measurementId: "G-HV5N0LQJTG"
    };

    let db;
    let isSubmitting = false;
    
    // Initialize Firebase with error handling
    function initializeFirebase() {
      return new Promise((resolve, reject) => {
        try {
          if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
          }
          db = firebase.firestore();
          console.log("Firebase initialized successfully");
          resolve();
        } catch (error) {
          console.error("Firebase initialization failed:", error);
          reject(error);
        }
      });
    }

    // Timeout wrapper for promises
    function withTimeout(promise, ms) {
      return new Promise((resolve, reject) => {
        const timeoutId = setTimeout(() => {
          reject(new Error(`Operation timed out after ${ms}ms`));
        }, ms);
        
        promise.then(
          (result) => {
            clearTimeout(timeoutId);
            resolve(result);
          },
          (error) => {
            clearTimeout(timeoutId);
            reject(error);
          }
        );
      });
    }

    // Update progress bar
    function updateProgress(percentage) {
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      
      if (percentage > 0) {
        progressBar.style.display = 'block';
        progressFill.style.width = percentage + '%';
      } else {
        progressBar.style.display = 'none';
        progressFill.style.width = '0%';
      }
    }

    // Show status message
    function showStatus(message, type = 'info') {
      const statusElement = document.getElementById('statusMessage');
      statusElement.textContent = message;
      statusElement.className = `status-message ${type}`;
      statusElement.style.display = 'block';
    }

    // Hide status message
    function hideStatus() {
      const statusElement = document.getElementById('statusMessage');
      statusElement.style.display = 'none';
    }

    // Reset form state
    function resetFormState() {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Product';
      updateProgress(0);
      isSubmitting = false;
    }

    // Process image with timeout and size check
    function processImage(file) {
      return new Promise((resolve, reject) => {
        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          reject(new Error('Image size must be less than 5MB'));
          return;
        }

        const reader = new FileReader();
        const timeout = setTimeout(() => {
          reader.abort();
          reject(new Error('Image processing timed out'));
        }, 30000); // 30 second timeout

        reader.onload = function() {
          clearTimeout(timeout);
          resolve(reader.result);
        };

        reader.onerror = function() {
          clearTimeout(timeout);
          reject(new Error('Failed to read image file'));
        };

        reader.readAsDataURL(file);
      });
    }

    // Initialize on page load
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("productForm");
      const allowedEmail = "mrazwan0310@gmail.com";
      
      // Initialize Firebase
      initializeFirebase().catch(error => {
        console.error("Firebase initialization failed:", error);
        showStatus("Warning: Connection issues detected. Products will be saved locally.", "warning");
      });

      const errors = {
        title: document.getElementById("titleError"),
        image: document.getElementById("imageError"),
        price: document.getElementById("priceError"),
        category: document.getElementById("categoryError"),
        description: document.getElementById("descriptionError"),
        link: document.getElementById("linkError"),
        email: document.getElementById("emailError"),
      };

      function clearErrors() {
        Object.values(errors).forEach((el) => (el.textContent = ""));
      }

      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        
        if (isSubmitting) {
          return; // Prevent double submission
        }

        isSubmitting = true;
        clearErrors();
        hideStatus();

        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";
        
        showStatus("Validating form data...", "info");
        updateProgress(10);

        try {
          // Get form values
          const title = document.getElementById("productTitle").value.trim();
          const imageInput = document.getElementById("productImage");
          const price = document.getElementById("price").value.trim();
          const description = document.getElementById("description").value.trim();
          const link = document.getElementById("productLink").value.trim();
          const email = document.getElementById("email").value.trim();
          const category = document.getElementById("category").value;

          let valid = true;

          // Validation
          if (!title) {
            errors.title.textContent = "Product title is required.";
            valid = false;
          }

          if (!imageInput.files[0]) {
            errors.image.textContent = "Please upload an image.";
            valid = false;
          }

          if (!price || isNaN(price) || parseFloat(price) <= 0) {
            errors.price.textContent = "Please enter a valid price greater than 0.";
            valid = false;
          }

          if (!description) {
            errors.description.textContent = "Description is required.";
            valid = false;
          }

          if (!link) {
            errors.link.textContent = "Product link is required.";
            valid = false;
          } else {
            try {
              new URL(link);
            } catch {
              errors.link.textContent = "Please enter a valid URL.";
              valid = false;
            }
          }

          if (email !== allowedEmail) {
            errors.email.textContent = "Invalid email address.";
            valid = false;
          }

          if (!category) {
            errors.category.textContent = "Please select a category.";
            valid = false;
          }

          if (!valid) {
            showStatus("Please fix the validation errors above.", "error");
            resetFormState();
            return;
          }

          updateProgress(30);
          showStatus("Processing image...", "info");

          // Process image with timeout
          const imageData = await withTimeout(
            processImage(imageInput.files[0]),
            30000
          );

          updateProgress(60);
          showStatus("Submitting to server...", "info");

          // Create product object
          const product = {
            title,
            imageData,
            price: parseFloat(price),
            description,
            link,
            category,
            rating: 5,
            reviews: 0,
            featured: true,
            createdAt: Date.now(),
            submittedBy: email
          };

          // Try to submit to Firebase with timeout
          let docRef;
          try {
            docRef = await withTimeout(
              db.collection("products").add(product),
              15000
            );
            console.log("Product submitted successfully:", docRef.id);
            
            // Update local storage
            const existing = JSON.parse(localStorage.getItem("products") || "[]");
            existing.push({ ...product, id: docRef.id });
            localStorage.setItem("products", JSON.stringify(existing));

            updateProgress(100);
            showStatus("Product submitted successfully! Redirecting...", "success");

            // Redirect after success
            setTimeout(() => {
              window.location.href = "products.html";
            }, 2000);

          } catch (firebaseError) {
            console.error("Firebase submission failed:", firebaseError);
            
            // Fallback to local storage
            try {
              const existing = JSON.parse(localStorage.getItem("products") || "[]");
              existing.push({ ...product, id: 'local_' + Date.now() });
              localStorage.setItem("products", JSON.stringify(existing));
              
              updateProgress(100);
              showStatus("Saved locally. Will sync when connection is restored.", "warning");
              
              setTimeout(() => {
                window.location.href = "products.html";
              }, 2000);
              
            } catch (localError) {
              console.error("Local storage failed:", localError);
              throw new Error("Failed to save product. Please try again.");
            }
          }

        } catch (error) {
          console.error("Submission error:", error);
          showStatus(`Error: ${error.message}`, "error");
          resetFormState();
        }
      });
    });
  </script>
</body>
</html>